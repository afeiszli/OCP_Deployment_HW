iapiVersion: v1
kind: BuildConfig
metadata:
  name: tasks-pipeline
  labels:
    app: openshift-tasks
    name: tasks-pipeline
    template: openshift-tasks-pipeline-template
spec:
  runPolicy: Serial
  strategy:
    type: JenkinsPipeline
    jenkinsPipelineStrategy:
      jenkinsfile: |-
        node('') {
          stage 'Build Tasks App in tasks-build project'
            openshiftBuild(namespace:'tasks-build',buildConfig: 'tasks', showBuildLogs: 'true')
          stage 'Deploy Tasks App in Dev'
            openshiftDeploy(namespace:'tasks-dev',deploymentConfig: 'tasks')
            openshiftScale(namespace:'tasks',deploymentConfig: 'tasks',replicaCount: '1')
          stage 'Deploy Tasks App in Test'
            input 'Is Dev ready to move to Test?'
            openshiftTag(namespace: 'cicd-dev', sourceStream: 'tasks',  sourceTag: 'latest', destinationStream: 'tasks', destinationTag: 'qa')
            openshiftDeploy(namespace:'tasks-test',deploymentConfig: 'tasks')
            openshiftScale(namespace:'tasks-test',deploymentConfig: 'tasks',replicaCount: '1')
          stage 'Deploy Tasks App in Prod'
            input 'Is Test approved for Production?'
            openshiftTag(namespace: 'cicd-dev', sourceStream: 'tasks',  sourceTag: 'qa', destinationStream: 'tasks', destinationTag: 'prod')
            openshiftDeploy(namespace:'tasks-prod',deploymentConfig: 'tasks')
            openshiftScale(namespace:'tasks-prod',deploymentConfig: 'tasks',replicaCount: '1')

}
